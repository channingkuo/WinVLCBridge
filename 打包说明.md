# WinVLCBridge 打包说明

本文档说明如何打包 WinVLCBridge.dll 及其依赖文件，用于分发和部署。

## 📦 打包内容

编译完成后需要打包的文件：

```
WinVLCBridge-Package/
├── WinVLCBridge.dll        # 主要的桥接库
├── libvlc.dll              # VLC 核心库
├── libvlccore.dll          # VLC 核心库
└── plugins/                # VLC 插件目录（完整）
    ├── access/
    ├── audio_filter/
    ├── audio_output/
    ├── codec/
    ├── control/
    ├── demux/
    ├── lua/
    ├── meta_engine/
    ├── misc/
    ├── packetizer/
    ├── services_discovery/
    ├── stream_filter/
    ├── text_renderer/
    ├── video_chroma/
    ├── video_filter/
    └── video_output/
```

## 🛠️ 打包步骤

### 方法 1：使用构建脚本（推荐）

构建脚本会自动复制所有必要文件到 `build/bin/Release/` 目录。

```cmd
cd WinVLCBridge
build.bat release
```

编译完成后，`build/bin/Release/` 目录包含所有需要的文件。

### 方法 2：手动打包

1. **编译 DLL**
   ```cmd
   cd WinVLCBridge/build
   cmake --build . --config Release
   ```

2. **创建打包目录**
   ```cmd
   mkdir WinVLCBridge-Package
   ```

3. **复制主 DLL**
   ```cmd
   copy build\bin\Release\WinVLCBridge.dll WinVLCBridge-Package\
   ```

4. **复制 VLC DLLs**
   ```cmd
   copy vlc-3.0.21\libvlc.dll WinVLCBridge-Package\
   copy vlc-3.0.21\libvlccore.dll WinVLCBridge-Package\
   ```

5. **复制 plugins 目录**
   ```cmd
   xcopy /E /I vlc-3.0.21\plugins WinVLCBridge-Package\plugins
   ```

6. **验证文件完整性**
   ```cmd
   dir WinVLCBridge-Package /s
   ```

## 📋 文件清单

### 必需文件

| 文件 | 大小（约） | 说明 |
|------|-----------|------|
| WinVLCBridge.dll | ~200 KB | 桥接库主文件 |
| libvlc.dll | ~200 KB | VLC 接口库 |
| libvlccore.dll | ~3 MB | VLC 核心功能 |
| plugins/ | ~60 MB | VLC 插件（完整） |

**总大小：约 65 MB**

### 可选文件

如果你确定只使用特定格式（如 MP4），可以精简 plugins：

**最小插件集（约 10 MB）：**
```
plugins/
├── access/              # 必需
│   ├── libfilesystem_plugin.dll
│   └── libhttp_plugin.dll
├── codec/               # 必需
│   ├── libavcodec_plugin.dll
│   └── libh264_plugin.dll
├── demux/               # 必需
│   └── libmp4_plugin.dll
├── video_output/        # 必需
│   └── libdirect3d11_plugin.dll
└── audio_output/        # 如需音频
    └── libwaveout_plugin.dll
```

> ⚠️ **警告**：精简插件可能导致某些视频格式无法播放，建议保留完整的 plugins 目录。

## 📦 创建分发包

### 创建 ZIP 压缩包

使用 PowerShell 创建压缩包：

```powershell
cd WinVLCBridge
Compress-Archive -Path build\bin\Release\* -DestinationPath WinVLCBridge-v1.0.0-win64.zip
```

或使用 7-Zip（如果已安装）：

```cmd
7z a -tzip WinVLCBridge-v1.0.0-win64.zip build\bin\Release\*
```

### 创建安装包（可选）

使用 [Inno Setup](https://jrsoftware.org/isinfo.php) 创建安装程序：

1. 安装 Inno Setup
2. 创建 `installer.iss` 脚本：

```ini
[Setup]
AppName=WinVLCBridge
AppVersion=1.0.0
DefaultDirName={pf}\WinVLCBridge
OutputBaseFilename=WinVLCBridge-Setup-v1.0.0
Compression=lzma2
SolidCompression=yes

[Files]
Source: "build\bin\Release\*"; DestDir: "{app}"; Flags: recursesubdirs
```

3. 编译安装程序：
```cmd
iscc installer.iss
```

## 🚀 集成到 Electron 项目

### 方法 1：直接包含

将打包的文件复制到 Electron 项目：

```
your-electron-app/
└── resources/
    └── native/
        ├── WinVLCBridge.dll
        ├── libvlc.dll
        ├── libvlccore.dll
        └── plugins/
```

在代码中加载：

```javascript
const path = require('path');
const dllPath = path.join(process.resourcesPath, 'native', 'WinVLCBridge.dll');
```

### 方法 2：使用 electron-builder

在 `package.json` 中配置：

```json
{
  "build": {
    "win": {
      "extraResources": [
        {
          "from": "native/",
          "to": "native/",
          "filter": ["**/*"]
        }
      ]
    }
  }
}
```

### 方法 3：ASAR 外部文件

某些 DLL 需要在 ASAR 外部：

```json
{
  "build": {
    "asarUnpack": [
      "native/**/*"
    ]
  }
}
```

## ✅ 部署检查清单

打包前检查：

- [ ] 使用 Release 配置编译
- [ ] 包含所有 DLL 文件
- [ ] 包含完整的 plugins 目录
- [ ] 测试在干净的 Windows 系统上运行
- [ ] 检查是否需要 Visual C++ 运行库

### 检测依赖

使用 [Dependency Walker](http://www.dependencywalker.com/) 检查 DLL 依赖：

```cmd
depends.exe WinVLCBridge.dll
```

常见依赖：
- `KERNEL32.DLL` ✅（系统自带）
- `MSVCR120.DLL` ⚠️（可能需要 VC++ 运行库）
- `gdiplus.dll` ✅（系统自带）

### Visual C++ 运行库

如果需要 VC++ 运行库，包含安装程序：

```
https://aka.ms/vs/17/release/vc_redist.x64.exe
```

或在 Inno Setup 中自动安装：

```ini
[Files]
Source: "vcredist_x64.exe"; DestDir: "{tmp}"; Flags: deleteafterinstall

[Run]
Filename: "{tmp}\vcredist_x64.exe"; Parameters: "/quiet /norestart"; StatusMsg: "安装 Visual C++ 运行库..."
```

## 📝 版本管理

### 版本号规范

使用语义化版本：`主版本.次版本.修订版本`

- **主版本**：API 不兼容的改动
- **次版本**：向后兼容的功能新增
- **修订版本**：向后兼容的问题修正

示例：`v1.2.3`

### 文件命名

建议格式：`WinVLCBridge-v{版本号}-{平台}.{格式}`

示例：
- `WinVLCBridge-v1.0.0-win64.zip`
- `WinVLCBridge-v1.0.0-win32.zip`
- `WinVLCBridge-Setup-v1.0.0.exe`

### 版本信息嵌入

在 CMakeLists.txt 中添加版本资源：

```cmake
set(VERSION_MAJOR 1)
set(VERSION_MINOR 0)
set(VERSION_PATCH 0)

configure_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/version.rc.in
    ${CMAKE_CURRENT_BINARY_DIR}/version.rc
    @ONLY
)

target_sources(${PROJECT_NAME} PRIVATE ${CMAKE_CURRENT_BINARY_DIR}/version.rc)
```

## 🔒 签名（可选）

为 DLL 签名以增加可信度：

```cmd
signtool sign /f certificate.pfx /p password /tr http://timestamp.digicert.com WinVLCBridge.dll
```

## 📊 测试打包

### 在虚拟机中测试

1. 创建干净的 Windows 虚拟机
2. 复制打包的文件
3. 运行测试程序
4. 确认无依赖问题

### 自动化测试脚本

创建 `test_package.bat`：

```batch
@echo off
echo 测试 WinVLCBridge 打包...
echo.

if not exist WinVLCBridge.dll (
    echo [失败] 找不到 WinVLCBridge.dll
    exit /b 1
)

if not exist libvlc.dll (
    echo [失败] 找不到 libvlc.dll
    exit /b 1
)

if not exist plugins\ (
    echo [失败] 找不到 plugins 目录
    exit /b 1
)

echo [成功] 所有文件齐全
echo.
echo 文件列表:
dir /b
echo.
echo 插件数量:
dir /s /b plugins\*.dll | find /c ".dll"
```

## 📤 发布流程

1. **编译 Release 版本**
   ```cmd
   build.bat release
   ```

2. **创建分发包**
   ```cmd
   cd build\bin\Release
   tar -czf WinVLCBridge-v1.0.0-win64.tar.gz *
   ```

3. **生成校验和**
   ```powershell
   Get-FileHash WinVLCBridge-v1.0.0-win64.tar.gz -Algorithm SHA256
   ```

4. **上传到发布平台**
   - GitHub Releases
   - 公司服务器
   - CDN

5. **更新文档**
   - 更新 CHANGELOG
   - 更新下载链接

## 🌐 CDN 部署（可选）

如果需要通过网络分发：

```javascript
const https = require('https');
const fs = require('fs');

const url = 'https://cdn.example.com/WinVLCBridge-v1.0.0-win64.zip';
const dest = 'WinVLCBridge.zip';

https.get(url, (response) => {
    response.pipe(fs.createWriteStream(dest));
});
```

## 📋 分发清单模板

```
WinVLCBridge v1.0.0 - Windows x64
==================================

包含文件：
  ✓ WinVLCBridge.dll (主要库)
  ✓ libvlc.dll (VLC 库)
  ✓ libvlccore.dll (VLC 核心)
  ✓ plugins/ (VLC 插件)

系统要求：
  - Windows 7/8/10/11 (64位)
  - Visual C++ 运行库 2015-2022

安装方法：
  1. 解压到任意目录
  2. 将目录添加到 PATH 或放在程序同级目录
  3. 使用 ffi-napi 加载 WinVLCBridge.dll

文档：
  - README.md - 完整文档
  - QUICK_START.md - 快速开始
  - example_usage.js - 代码示例

支持：
  - GitHub: https://github.com/your/repo
  - Email: support@example.com
```

## 🎯 总结

打包 WinVLCBridge.dll 的关键点：

1. ✅ 使用 Release 配置编译
2. ✅ 包含所有 VLC 依赖（DLL + plugins）
3. ✅ 测试在干净系统上运行
4. ✅ 提供清晰的文档和示例
5. ✅ 考虑 VC++ 运行库依赖

完成这些步骤后，你的 DLL 就可以安全分发了！

---

**下一步：** 查看 [QUICK_START.md](QUICK_START.md) 了解如何在项目中使用打包的 DLL。

